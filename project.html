<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="./project.css" />
    <title>Project</title>
  </head>
  <body>
    <button class="burger-menu-btn d-md-none" onclick="toggleMenu()">â˜°</button>
    <nav>
      <div class="d-flex justify-content-between mx-3">
        <h1>Projects</h1>
        <button class="btn btn-sm btn-danger logoutBtn">LOGOUT</button>
      </div>
    </nav>

    <!-- Burger menu button for small and medium screens -->
    <!-- <button class="burger-menu-btn d-md-none" onclick="toggleMenu()">â˜°</button> -->

    <div class="burger-menu">
      <ul class="burger-menu-list">
        <li>
          <button
            class="btn btn-secondary my-3"
            data-bs-toggle="modal"
            data-bs-target="#create-project-modal"
          >
            Create Project <span>+</span>
          </button>
        </li>
        <li>
          <button class="btn btn-secondary dashboard">
            Report and Analysis
          </button>
        </li>
        <li><button class="btn btn-secondary calender">Calendar</button></li>
      </ul>
    </div>

    <main class="d-flex">
      <aside class="rounded-4 m-3">
        <div>
          <button
            type="button"
            class="btn btn-secondary my-3"
            data-bs-toggle="modal"
            data-bs-target="#create-project-modal"
          >
            Create Project <span>+</span>
          </button>
        </div>
        <div class="mb-3">
          <button class="btn btn-secondary dashboard_aside">
            Report and Analysis
          </button>
        </div>
        <div class="mb-3">
          <button class="btn btn-secondary calender_aside">calender</button>
        </div>
      </aside>

      <section class="flex-grow-1 table-section card rounded-4 m-3">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Description</th>
                <th scope="col">Created By</th>
                <th scope="col">Created At</th>
                <th scope="col">Create Task</th>
              </tr>
            </thead>
            <tbody id="projectList">
              <!-- Populated dynamically with JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- CREATE PROJECT Modal -->
        <div id="create-project-modal" class="modal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Create Project</h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <label for="project_name" class="form-label">Name</label>
                <input type="text" class="form-control" id="project_name" />

                <label for="project_description" class="form-label"
                  >Description</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="project_description"
                />
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Close
                </button>
                <button
                  type="button"
                  onClick="createProject()"
                  class="btn btn-primary"
                >
                  Create
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Delete Project Modal -->
        <div id="delete-task-modal" class="modal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Delete Project</h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <p>Are you sure you want to delete this Project?</p>
                <input
                  type="text"
                  disabled
                  class="visually-hidden"
                  id="delete_project_id"
                />
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  No
                </button>
                <button
                  type="button"
                  onClick="deleteProject()"
                  class="btn btn-primary"
                >
                  Yes
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- CREATE TASK Modal -->
        <div id="create-task-modal" class="modal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Create Task</h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <label for="task_name" class="form-label">Name</label>
                <input type="text" class="form-control" id="task_name" />

                <label for="task_description" class="form-label"
                  >Description</label
                >
                <input type="text" class="form-control" id="task_description" />

                <label for="task_project" class="form-label">Project</label>
                <input
                  type="text"
                  disabled
                  class="form-control"
                  id="task_project"
                />
                <input
                  type="text"
                  disabled
                  class="visually-hidden"
                  id="task_project_id"
                />
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Close
                </button>
                <button
                  type="button"
                  onClick="createTask()"
                  class="btn btn-primary"
                >
                  Create
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </body>
  <script>
    // JavaScript Code
    const modalCreateProjectForm = document.getElementById(
      "modalCreateProjectForm"
    );

    // create Project

    const createProject = () => {
      const accessToken = localStorage.getItem("user.accessToken");
      const data = {
        name: document.getElementById("project_name").value,
        description: document.getElementById("project_description").value,
      };

      fetch("https://time-trace-backend.onrender.com/project/create", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${accessToken}`,
        },
        body: JSON.stringify(data),
      })
        .then((res) => res.json())
        .then((res) => {
          if (res) {
            fetch("https://time-trace-backend.onrender.com/project/", {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((res) => res.json())
              .then((res) => {
                console.log(res);
                displayProjectDetails(res.projects);
              });
          }
        })
        .catch((err) => console.log(err));
    };

    //create task
    const createTask = () => {
      const data = {
        name: document.getElementById("task_name").value,
        description: document.getElementById("task_description").value,
        projectId: document.getElementById("task_project_id").value,
      };
      console.log(data);

      fetch("https://time-trace-backend.onrender.com/task/create", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      })
        .then((res) => res.json())
        .then((res) => {
          console.log(res);
          localStorage.setItem("projectId", JSON.stringify(res));
          window.location.href = `./task.html?taskId=${res.savedTask._id}`;
        })
        .catch((err) => console.log(err));
    };

    //delete task
    const deleteProject = () => {
      const projectId = document.querySelector("#delete_project_id").value;
      if (!projectId) {
        console.log("project id not found");
        return;
      }

      fetch(`https://time-trace-backend.onrender.com/project/${projectId}`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
        },
      })
        .then((res) => res.json())
        .then((res) => {
          console.log(res);
          window.location.reload();
        })
        .catch((err) => console.log(err));
    };

    window.onload = () => {
      const accessToken = localStorage.getItem("user.accessToken");
      fetch("https://time-trace-backend.onrender.com/project/", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${accessToken}`,
        },
      })
        .then((res) => res.json())
        .then((res) => {
          console.log(res);
          displayProjectDetails(res.projects);
        })
        .catch((error) => {
          console.error("Error fetching data:", error);
        });
    };

    let taskModalProjectValue = null;

    function displayProjectDetails(projects) {
      const tableBody = document.getElementById("projectList");
      tableBody.innerHTML = "";
      projects.forEach((project) => {
        const row = document.createElement("tr");

        const nameCell = document.createElement("td");
        nameCell.textContent = project.name;

        const descriptionCell = document.createElement("td");
        descriptionCell.textContent = project.description;

        const createdByCell = document.createElement("td");
        createdByCell.textContent = project.createdBy;

        const createdAtCell = document.createElement("td");
        createdAtCell.textContent = dayjs(project.createdAt).format(
          "MMM DD, YYYY h:mm A"
        );

        const createTaskCell = document.createElement("td");
        const createTaskButton = document.createElement("button");
        createTaskButton.setAttribute("class", "btn btn-secondary");
        createTaskButton.dataset.bsToggle = "modal";
        createTaskButton.dataset.bsTarget = "#create-task-modal";
        createTaskButton.dataset.id = project._id;
        createTaskButton.addEventListener("click", () => {
          document.querySelector("#task_project").value = project.name;
          document.querySelector("#task_project_id").value = project._id;
        });
        createTaskButton.textContent = "+";

        createTaskCell.appendChild(createTaskButton);

        const deleteTaskCell = document.createElement("td");
        const deleteTaskButton = document.createElement("button");
        deleteTaskButton.setAttribute("class", "btn btn-secondary");
        deleteTaskButton.dataset.bsToggle = "modal";
        deleteTaskButton.dataset.bsTarget = "#delete-task-modal";
        deleteTaskButton.dataset.id = project._id;
        deleteTaskButton.addEventListener("click", () => {
          document.querySelector("#delete_project_id").value = project._id;
        });
        deleteTaskButton.textContent = "ðŸ—‘ï¸";

        deleteTaskCell.appendChild(deleteTaskButton);

        row.appendChild(nameCell);
        row.appendChild(descriptionCell);
        row.appendChild(createdByCell);
        row.appendChild(createdAtCell);
        row.appendChild(createTaskCell);
        row.appendChild(deleteTaskCell);

        tableBody.appendChild(row);
      });
    }

    let dashboard = document.querySelector(".dashboard");

    dashboard.addEventListener("click", () => {
      window.location.href = "./dashboard.html";
    });
    let calender = document.querySelector(".calender");
    calender.addEventListener("click", () => {
      window.location.href = "./calender/calender.html";
    });

    let dashboard_aside = document.querySelector(".dashboard_aside");
    dashboard_aside.addEventListener("click", () => {
      window.location.href = "/dashboard.html";
    });

    let calender_aside = document.querySelector(".calender_aside");
    calender_aside.addEventListener("click", () => {
      window.location.href = "./calender/calender.html";
    });

    let logout = document.querySelector(".logoutBtn");
    logout.addEventListener("click", () => {
      window.location.href = "/index.html";
    });

    function toggleMenu() {
      const burgerMenu = document.querySelector(".burger-menu");
      burgerMenu.classList.toggle("show");
    }
  </script>
</html>
